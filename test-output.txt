MNEMONIC_MAINNET_DEPLOYER is not set in the .env file
No private keys found for katana_mainnet in the .env file


  Compare library
    isWithinTolerance
      âœ” returns true when values are equal and tolerance is 0 (447ms)
      âœ” returns false when difference is 1 and tolerance is 0
      âœ” returns true when difference equals tolerance boundary
      âœ” returns true when difference is below tolerance and false when above
      âœ” handles zero values correctly
      âœ” handles extreme max uint256 values
      âœ” is symmetric for observed < expected and observed > expected
    checkBalanceDelta
      âœ” Increase: direction false when after <= before
      âœ” Increase: correct delta and tolerance within/at/above boundary
      âœ” Decrease: direction false when after >= before
      âœ” Decrease: correct delta and tolerance within/at/above boundary
      âœ” handles extreme max uint256 delta for Increase
      âœ” handles extreme max uint256 delta for Decrease
      âœ” tolerance = max always passes when direction is satisfied

  SwappableVault Tolerance Tests
    Tolerance Constant
      âœ” should have BALANCE_DIFF_TOLERANCE = 1
    Happy Path Tests
      âœ” should succeed when spent equals returned amount (exact match)
      âœ” should succeed when difference is +1 (within tolerance)
      âœ” should succeed when difference is -1 (within tolerance)
    Failure Cases - Outside Tolerance
      âœ” should revert when difference is +2 (outside tolerance)
      âœ” should revert when difference is -2 (outside tolerance)
    Amount In Maximum Checks
      âœ” should revert when spent > amountInMaximum (exceeds maximum)
      âœ” should revert with correct error when spent = amountInMaximum + 1
    Output Token Validation
      âœ” should succeed when output amount is exact match
      âœ” should succeed when receiving +1 output token (within tolerance)
      âœ” should succeed when receiving -1 output token (within tolerance)
      âœ” should revert when receiving +2 output tokens (outside tolerance)
      âœ” should revert when receiving -2 output tokens (outside tolerance)
      âœ” should revert when output token balance doesn't increase
    Edge Cases
      âœ” should handle zero amounts correctly
      âœ” should handle exactly at tolerance boundary
    Gas Usage
      âœ” should not significantly increase gas usage

  WithdrawalFee math overflow protection
    âœ” _calculateWithdrawalFee handles uint256 max without overflow

  AmoManager Ecosystem Tests for dUSD
    AMO ecosystem interactions
Deployed USDC (USD Coin) at 0xCA8c8688914e0F7096c920146cd0Ad85cD7Ae8b9
Deployed USDT (Tether USD) at 0xB0f05d25e41FbC2b52013099ED9616f1206Ae21B
Deployed AUSD (AUSD) at 0x5FeaeBfB4439F3516c74939A9D04e95AFE82C4ae
Deployed yUSD (YieldFi yUSD) at 0x976fcd02f7C4773dd89C309fBF55D5923B4c98a1
Deployed frxUSD (Frax USD) at 0x19cEcCd6942ad38562Ee10bAfd44776ceB67e923
Deployed sfrxUSD (Staked Frax USD) at 0xD42912755319665397FF090fBB63B1a31aE87Cee
Deployed WETH (Wrapped ETH) at 0xfcDB4564c18A9134002b9771816092C9693622e3
Deployed stETH (Staked ETH) at 0x927b167526bAbB9be047421db732C663a0b77B11
ðŸª™  deploy-mocks/01_mock_token_setup.ts: âœ…
Deployed MockRedstoneChainlinkOracleAlwaysAlive_WETH_USD at 0x32EEce76C2C2e8758584A83Ee2F522D4788feA0f with price 2500
Deployed MockRedstoneChainlinkOracleAlwaysAlive_USDC_USD at 0x02b0B4EFd909240FCB2Eb5FAe060dC60D112E3a4 with price 1
Deployed MockRedstoneChainlinkOracleAlwaysAlive_USDT_USD at 0x6C2d83262fF84cBaDb3e416D527403135D757892 with price 1
Deployed MockRedstoneChainlinkOracleAlwaysAlive_AUSD_USD at 0xa6e99A4ED7498b3cdDCBB61a6A607a4925Faa1B7 with price 1
Deployed MockRedstoneChainlinkOracleAlwaysAlive_frxUSD_USD at 0x0ed64d01D0B4B655E410EF1441dD677B695639E7 with price 1
Deployed MockRedstoneChainlinkOracleAlwaysAlive_sfrxUSD_frxUSD at 0x40a42Baf86Fc821f972Ad2aC878729063CeEF403 with price 1.1
Deployed MockRedstoneChainlinkOracleAlwaysAlive_yUSD_USD at 0x986aaa537b8cc170761FDAC6aC4fc7F9d8a20A8C with price 1.1
Deployed MockRedstoneChainlinkOracleAlwaysAlive_stETH_WETH at 0xefc1aB2475ACb7E60499Efb171D173be19928a05 with price 1.1
ðŸ”® deploy-mocks/02_mock_oracle_setup.ts: âœ…
Deployed MockUniversalRewardsDistributor at 0xD49a0e9A4CD5979aE36840f542D2d7f02C4817Be
âš ï¸  Skipping mock Curve pool deployment: dPool functionality disabled in this fork
â˜¯ï¸ 01_dusd_token.ts: âœ…
Set plain Redstone feed for asset 0xfcDB4564c18A9134002b9771816092C9693622e3 to 0x32EEce76C2C2e8758584A83Ee2F522D4788feA0f
Set plain Redstone feed for asset 0x976fcd02f7C4773dd89C309fBF55D5923B4c98a1 to 0x986aaa537b8cc170761FDAC6aC4fc7F9d8a20A8C
Sanity check passed for asset 0xfcDB4564c18A9134002b9771816092C9693622e3 in plain Redstone proxies: Normalized price is 2500
Sanity check passed for asset 0x976fcd02f7C4773dd89C309fBF55D5923B4c98a1 in plain Redstone proxies: Normalized price is 1.1
Set Redstone feed with thresholding for asset 0xCA8c8688914e0F7096c920146cd0Ad85cD7Ae8b9
Set Redstone feed with thresholding for asset 0xB0f05d25e41FbC2b52013099ED9616f1206Ae21B
Set Redstone feed with thresholding for asset 0x5FeaeBfB4439F3516c74939A9D04e95AFE82C4ae
Set Redstone feed with thresholding for asset 0x19cEcCd6942ad38562Ee10bAfd44776ceB67e923
Sanity check passed for asset 0xCA8c8688914e0F7096c920146cd0Ad85cD7Ae8b9 in Redstone proxies with thresholding: Normalized price is 1
Sanity check passed for asset 0xB0f05d25e41FbC2b52013099ED9616f1206Ae21B in Redstone proxies with thresholding: Normalized price is 1
Sanity check passed for asset 0x5FeaeBfB4439F3516c74939A9D04e95AFE82C4ae in Redstone proxies with thresholding: Normalized price is 1
Sanity check passed for asset 0x19cEcCd6942ad38562Ee10bAfd44776ceB67e923 in Redstone proxies with thresholding: Normalized price is 1
Set composite Redstone feed for asset 0xD42912755319665397FF090fBB63B1a31aE87Cee
Set composite Redstone feed for asset 0x927b167526bAbB9be047421db732C663a0b77B11
Sanity check passed for asset 0xD42912755319665397FF090fBB63B1a31aE87Cee in composite Redstone feeds: Normalized price is 1.1
Sanity check passed for asset 0x927b167526bAbB9be047421db732C663a0b77B11 in composite Redstone feeds: Normalized price is 2750
ðŸ”® 02_dusd_ecosystem/02_setup_usd_redstone_oracle_wrappers.ts: âœ…
ðŸ”® 02_dusd_ecosystem/04_deploy_usd_oracle_aggregator.ts: âœ…
Set plain Redstone wrapper for asset 0xfcDB4564c18A9134002b9771816092C9693622e3 to 0xB377a2EeD7566Ac9fCb0BA673604F9BF875e2Bab
Set plain Redstone wrapper for asset 0x976fcd02f7C4773dd89C309fBF55D5923B4c98a1 to 0xB377a2EeD7566Ac9fCb0BA673604F9BF875e2Bab
Set Redstone wrapper with thresholding for asset 0xCA8c8688914e0F7096c920146cd0Ad85cD7Ae8b9 to 0x74Cf9087AD26D541930BaC724B7ab21bA8F00a27
Set Redstone wrapper with thresholding for asset 0xB0f05d25e41FbC2b52013099ED9616f1206Ae21B to 0x74Cf9087AD26D541930BaC724B7ab21bA8F00a27
Set Redstone wrapper with thresholding for asset 0x5FeaeBfB4439F3516c74939A9D04e95AFE82C4ae to 0x74Cf9087AD26D541930BaC724B7ab21bA8F00a27
Set Redstone wrapper with thresholding for asset 0x19cEcCd6942ad38562Ee10bAfd44776ceB67e923 to 0x74Cf9087AD26D541930BaC724B7ab21bA8F00a27
Set composite Redstone wrapper for asset 0xD42912755319665397FF090fBB63B1a31aE87Cee to 0xaB7B4c595d3cE8C85e16DA86630f2fc223B05057
Set composite Redstone wrapper for asset 0x927b167526bAbB9be047421db732C663a0b77B11 to 0xaB7B4c595d3cE8C85e16DA86630f2fc223B05057
ðŸ”® 02_dusd_ecosystem/06_point_usd_aggregator_to_redstone_wrappers.ts: âœ…
Setting HardPegOracleWrapper for dUSD (0xB2b580ce436E6F77A5713D80887e14788Ef49c9A) to 0xeF31027350Be2c7439C1b0BE022d49421488b72C
ðŸ”® 02_dusd_ecosystem/07_dusd_oracle.ts: âœ…
â˜¯ï¸ 02_dusd_ecosystem/08_collateral_vault.ts: âœ…
â˜¯ï¸ 02_dusd_ecosystem/09_amo_manager.ts: âœ…
  ðŸª™ Ensuring MINTER_ROLE for dUSD_IssuerV2 on dUSD...
    âž• Granted MINTER_ROLE to 0x63fea6E447F120B8Faf85B53cdaD8348e645D80E
  ðŸ” Migrating IssuerV2 roles to governance...
    âž• Granted DEFAULT_ADMIN_ROLE to governance 0x70997970C51812dc3A010C7d01b50e0d17dc79C8
    âž• Granted AMO_MANAGER_ROLE to governance 0x70997970C51812dc3A010C7d01b50e0d17dc79C8
    âž• Granted INCENTIVES_MANAGER_ROLE to governance 0x70997970C51812dc3A010C7d01b50e0d17dc79C8
    âž• Granted PAUSER_ROLE to governance 0x70997970C51812dc3A010C7d01b50e0d17dc79C8
  ðŸ”„ Revoking roles from deployer 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266...
    âž– Revoked AMO_MANAGER_ROLE from deployer
    âž– Revoked INCENTIVES_MANAGER_ROLE from deployer
    âž– Revoked PAUSER_ROLE from deployer
    âž– Renounced DEFAULT_ADMIN_ROLE for 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266 on IssuerV2
â˜¯ï¸ 02_dusd_ecosystem/10_issuer.ts: âœ…
Allowing Redeemer to withdraw collateral
    âž• Granted COLLATERAL_WITHDRAWER_ROLE to 0x071586BA1b380B00B793Cc336fe01106B0BFbE6D
  ðŸ” Migrating RedeemerV2 roles to governance...
    âž• Granted DEFAULT_ADMIN_ROLE to 0x70997970C51812dc3A010C7d01b50e0d17dc79C8
    âž• Granted REDEMPTION_MANAGER_ROLE to 0x70997970C51812dc3A010C7d01b50e0d17dc79C8
    âž• Granted PAUSER_ROLE to 0x70997970C51812dc3A010C7d01b50e0d17dc79C8
  ðŸ”„ Revoking roles from deployer 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266...
    âž– Revoked REDEMPTION_MANAGER_ROLE from deployer
    âž– Revoked PAUSER_ROLE from deployer
â˜¯ï¸ 02_dusd_ecosystem/11_redeemer.ts: âœ…
0xCA8c8688914e0F7096c920146cd0Ad85cD7Ae8b9 whitelisted as collateral
0xB0f05d25e41FbC2b52013099ED9616f1206Ae21B whitelisted as collateral
0x5FeaeBfB4439F3516c74939A9D04e95AFE82C4ae whitelisted as collateral
0x19cEcCd6942ad38562Ee10bAfd44776ceB67e923 whitelisted as collateral
0xD42912755319665397FF090fBB63B1a31aE87Cee whitelisted as collateral
0x976fcd02f7C4773dd89C309fBF55D5923B4c98a1 whitelisted as collateral
ðŸ”® 02_dusd_ecosystem/12_whitelist_collateral.ts: âœ…
Setting HardPegOracleWrapper for base currency (0x0000000000000000000000000000000000000000) to 0xeF31027350Be2c7439C1b0BE022d49421488b72C
ðŸ”® 02_dusd_ecosystem/13_point_usd_oracle_aggregator_for_usd.ts: âœ…
â‰» 01_deth_token.ts: âœ…
Set plain Redstone feed for asset 0x927b167526bAbB9be047421db732C663a0b77B11 to 0xefc1aB2475ACb7E60499Efb171D173be19928a05
Sanity check passed for asset 0x927b167526bAbB9be047421db732C663a0b77B11 in plain Redstone proxies: Normalized price is 1.1
ðŸ”® 01_deth_ecosystem/03_setup_eth_redstone_oracle_wrappers.ts: âœ…
ðŸ”® 01_deth_ecosystem/04_deploy_eth_oracle_aggregator.ts: âœ…
Set plain Redstone wrapper for asset 0x927b167526bAbB9be047421db732C663a0b77B11 to 0x51C65cd0Cdb1A8A8b79dfc2eE965B1bA0bb8fc89
ðŸ”® 01_deth_ecosystem/06_point_eth_aggregator_to_redstone_wrappers.ts: âœ…
Setting HardPegOracleWrapper for WETH (0xfcDB4564c18A9134002b9771816092C9693622e3) to 0xD5724171C2b7f0AA717a324626050BD05767e2C6
ðŸ”® 01_deth_ecosystem/07_weth_oracle.ts: âœ…
Setting HardPegOracleWrapper for dETH (0x87006e75a5B6bE9D1bbF61AC8Cd84f05D9140589) to 0x8B190573374637f144AC8D37375d97fd84cBD3a0
ðŸ”® 01_deth_ecosystem/08_deth_oracle.ts: âœ…
â‰» 01_deth_ecosystem/09_collateral_vault.ts: âœ…
â‰» 01_deth_ecosystem/10_amo_manager.ts: âœ…

â‰» 01_deth_ecosystem/11_issuer.ts: executing...
ðŸ” Governance multisig: 0x70997970C51812dc3A010C7d01b50e0d17dc79C8
  ðŸª™ Ensuring MINTER_ROLE for dETH_IssuerV2 on dETH...
    âž• Granted MINTER_ROLE to 0x114e375B6FCC6d6fCb68c7A1d407E652C54F25FB
  ðŸ” Migrating IssuerV2 roles to governance...
    âž• Granted DEFAULT_ADMIN_ROLE to governance 0x70997970C51812dc3A010C7d01b50e0d17dc79C8
    âž• Granted AMO_MANAGER_ROLE to governance 0x70997970C51812dc3A010C7d01b50e0d17dc79C8
    âž• Granted INCENTIVES_MANAGER_ROLE to governance 0x70997970C51812dc3A010C7d01b50e0d17dc79C8
    âž• Granted PAUSER_ROLE to governance 0x70997970C51812dc3A010C7d01b50e0d17dc79C8
  ðŸ”„ Revoking roles from deployer 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266...
    âž– Revoked AMO_MANAGER_ROLE from deployer
    âž– Revoked INCENTIVES_MANAGER_ROLE from deployer
    âž– Revoked PAUSER_ROLE from deployer
    âž– Renounced DEFAULT_ADMIN_ROLE for 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266 on IssuerV2

âœ… All operations completed successfully.

â‰» 01_deth_ecosystem/11_issuer.ts: âœ…
Allowing Redeemer to withdraw collateral
    âž• Granted COLLATERAL_WITHDRAWER_ROLE to 0xe1708FA6bb2844D5384613ef0846F9Bc1e8eC55E
  ðŸ” Migrating RedeemerV2 roles to governance...
    âž• Granted DEFAULT_ADMIN_ROLE to 0x70997970C51812dc3A010C7d01b50e0d17dc79C8
    âž• Granted REDEMPTION_MANAGER_ROLE to 0x70997970C51812dc3A010C7d01b50e0d17dc79C8
    âž• Granted PAUSER_ROLE to 0x70997970C51812dc3A010C7d01b50e0d17dc79C8
  ðŸ”„ Revoking roles from deployer 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266...
    âž– Revoked REDEMPTION_MANAGER_ROLE from deployer
    âž– Revoked PAUSER_ROLE from deployer
â‰» 01_deth_ecosystem/12_redeemer.ts: âœ…
0xfcDB4564c18A9134002b9771816092C9693622e3 whitelisted as collateral
0x927b167526bAbB9be047421db732C663a0b77B11 whitelisted as collateral
ðŸ”® 01_deth_ecosystem/13_whitelist_collateral.ts: âœ…
Running mock MetaMorpho vault deployment...
âœ… Deployed MockMetaMorphoVault_dUSD
âœ… Deployed MockMetaMorphoVault_dETH
ðŸ¥© deploy-mocks/04_deploy_mock_metamorpho_vaults.ts: âœ…
âš ï¸  Skipping dSTAKE instance sdUSD: Missing defaultDepositStrategyShare (likely due to dlend infrastructure not being deployed)
âš ï¸  Skipping dSTAKE instance sdETH: Missing defaultDepositStrategyShare (likely due to dlend infrastructure not being deployed)
ðŸ¥© 08_dstake/01_deploy_dstake_core.ts: âœ…
âš ï¸  Skipping dSTAKE instance sdUSD: Missing strategyShare for adapter WrappedDLendConversionAdapter (likely due to dlend infrastructure not being deployed)
âš ï¸  Skipping dSTAKE instance sdETH: Missing strategyShare for adapter WrappedDLendConversionAdapter (likely due to dlend infrastructure not being deployed)
ðŸ¥© 08_dstake/02_deploy_dstake_adapters.ts: âœ…
ðŸ“š Deploying DStakeRouterV2 libraries...
ðŸš€ Deploying DStakeRouterV2 for sdUSD...
duplicate definition - ArrayLengthMismatch()
duplicate definition - ArrayLengthMismatch()
âœ… Deployed DStakeRouterV2 for sdUSD at 0x7C8BaafA542c57fF9B2B90612bf8aB9E86e22C09
ðŸš€ Deploying DStakeRouterV2 for sdETH...
duplicate definition - ArrayLengthMismatch()
duplicate definition - ArrayLengthMismatch()
âœ… Deployed DStakeRouterV2 for sdETH at 0x0a17FabeA4633ce714F1Fa4a2dcA62C3bAc4758d
ðŸ¥© 08_dstake/06_deploy_router_v2.ts: âœ…
Registered MetaMorpho adapter for dUSD with router
Set default deposit vault asset for sdUSD router
Warning: sdUSD dStakeToken router not configured. This should have been done by configure script.
Registered MetaMorpho adapter for dETH with router
Set default deposit vault asset for sdETH router
Warning: sdETH dStakeToken router not configured. This should have been done by configure script.
âš™ï¸ Configuring DStakeRouterV2 for sdUSD...
    âž• Granted STRATEGY_REBALANCER_ROLE to 0x70997970C51812dc3A010C7d01b50e0d17dc79C8 for DStakeRouterV2_sdUSD
    âš ï¸  No MetaMorpho vault configurations to set for sdUSD
âœ… Completed configuration for DStakeRouterV2 sdUSD
âš™ï¸ Configuring DStakeRouterV2 for sdETH...
    âž• Granted STRATEGY_REBALANCER_ROLE to 0x70997970C51812dc3A010C7d01b50e0d17dc79C8 for DStakeRouterV2_sdETH
    âš ï¸  No MetaMorpho vault configurations to set for sdETH
âœ… Completed configuration for DStakeRouterV2 sdETH
ðŸ¥© 08_dstake/07_configure_router_v2.ts: âœ…
Deployed MetaMorpho reward managers:
    - sdUSD: 0x9fD16eA9E31233279975D99D5e8Fc91dd214c7Da
    - sdETH: 0xCBBe2A5c3A22BE749D5DDF24e9534f98951983e2
Setting up test permissions...
Granted MINTER_ROLE to deployer for dUSD testing
Granted MINTER_ROLE to deployer for dETH testing
Test permissions setup completed for dUSD and dETH tokens

ðŸ” Setting up new roles for dSTAKE instance sdUSDâ€¦
  ðŸ“„ ROUTER ROLES: DStakeRouterV2_sdUSD
    âž• Granted VAULT_MANAGER_ROLE to 0x70997970C51812dc3A010C7d01b50e0d17dc79C8
    âž• Granted CONFIG_MANAGER_ROLE to 0x70997970C51812dc3A010C7d01b50e0d17dc79C8
    âž• Granted PAUSER_ROLE to 0x70997970C51812dc3A010C7d01b50e0d17dc79C8
  ðŸ“„ REWARD MANAGER ROLES: DStakeRewardManagerMetaMorpho_sdUSD
    âž• Granted REWARDS_MANAGER_ROLE to 0x70997970C51812dc3A010C7d01b50e0d17dc79C8
  âœ… Completed role setup for sdUSD

ðŸ” Setting up new roles for dSTAKE instance sdETHâ€¦
  ðŸ“„ ROUTER ROLES: DStakeRouterV2_sdETH
    âž• Granted VAULT_MANAGER_ROLE to 0x70997970C51812dc3A010C7d01b50e0d17dc79C8
    âž• Granted CONFIG_MANAGER_ROLE to 0x70997970C51812dc3A010C7d01b50e0d17dc79C8
    âž• Granted PAUSER_ROLE to 0x70997970C51812dc3A010C7d01b50e0d17dc79C8
  ðŸ“„ REWARD MANAGER ROLES: DStakeRewardManagerMetaMorpho_sdETH
    âž• Granted REWARDS_MANAGER_ROLE to 0x70997970C51812dc3A010C7d01b50e0d17dc79C8
  âœ… Completed role setup for sdETH

ðŸ”‘ 08_dstake/09_update_router_roles.ts: âœ… Done

ðŸ”’ 10_vesting_dstake/01_deploy_vesting_nft.ts: âœ…
    âš™ï¸ Setting router for DStakeToken_sdUSD to 0x7C8BaafA542c57fF9B2B90612bf8aB9E86e22C09
    âš™ï¸ Setting collateral vault for DStakeToken_sdUSD to 0x9Fcca440F19c62CDF7f973eB6DDF218B15d4C71D
    âš™ï¸ Setting withdrawal fee for DStakeToken_sdUSD to 10
    âš™ï¸ Setting router for DStakeCollateralVault_sdUSD to 0x7C8BaafA542c57fF9B2B90612bf8aB9E86e22C09
    âš ï¸  Skipping adapter WrappedDLendConversionAdapter_sdUSD - not deployed yet
    âš ï¸  No defaultDepositStrategyShare configured for sdUSD, will be set by adapter deployment script
    âš™ï¸ Setting router for DStakeToken_sdETH to 0x0a17FabeA4633ce714F1Fa4a2dcA62C3bAc4758d
    âš™ï¸ Setting collateral vault for DStakeToken_sdETH to 0x1343248Cbd4e291C6979e70a138f4c774e902561
    âš™ï¸ Setting withdrawal fee for DStakeToken_sdETH to 10
    âš™ï¸ Setting router for DStakeCollateralVault_sdETH to 0x0a17FabeA4633ce714F1Fa4a2dcA62C3bAc4758d
    âš ï¸  Skipping adapter WrappedDLendConversionAdapter_sdETH - not deployed yet
    âš ï¸  No defaultDepositStrategyShare configured for sdETH, will be set by adapter deployment script
ðŸ¥© 08_dstake/03_configure_dstake.ts: âœ…
      âœ” verifies oracle prices for pegged and yield-bearing collateral
      âœ” calculates profit correctly with yield-bearing collateral
      âœ” calculates vault value with various assets
      âœ” transfers collateral between AMO vault and collateral vault

  AmoManager Ecosystem Tests for dETH
    AMO ecosystem interactions
      âœ” verifies oracle prices for pegged and yield-bearing collateral
      âœ” calculates profit correctly with yield-bearing collateral
      âœ” calculates vault value with various assets
      âœ” transfers collateral between AMO vault and collateral vault

  AmoManager
    AmoManager for dUSD
      Role-based access control
        âœ” should have correct role assignments after deployment
        âœ” should prevent unauthorized users from accessing restricted functions
      AMO allocation
        âœ” allocates AMO tokens to an active vault
        âœ” cannot allocate to an inactive vault
        âœ” cannot allocate more than unallocated supply
      AMO deallocation
        âœ” deallocates AMO tokens from an active vault
        âœ” cannot deallocate more than allocated to vault
      AMO vault management
        âœ” enables an AMO vault
        âœ” disables an AMO vault
        âœ” cannot enable an already enabled vault
        âœ” cannot disable an already disabled vault
      AMO supply management
        âœ” decreases AMO supply by burning dStable
        âœ” cannot decrease AMO supply more than available
      Collateral Management
        âœ” transfers collateral from AMO vault to holding vault
        âœ” transfers collateral from holding vault to AMO vault
        âœ” cannot transfer dStable as collateral
        âœ” does not reactivate a disabled vault when transferring collateral
        âœ” emits AllocationSurplus when collateral value exceeds allocation
      Profit Management
        âœ” calculates available vault profits correctly
        âœ” withdraws profits from AMO vault
        âœ” cannot withdraw more than available profits
      Base value conversion
        âœ” converts base value to dStable amount correctly
        âœ” converts dStable amount to base value correctly
      Admin functions
        âœ” allows admin to set collateral vault
        âœ” prevents non-admin from setting collateral vault
      AmoVault manager allowance
        âœ” revokes the old manager allowance and grants it to the new one
        âœ” allows admin to set a custom allowance for the current manager
    AmoManager for dETH
      Role-based access control
        âœ” should have correct role assignments after deployment
        âœ” should prevent unauthorized users from accessing restricted functions
      AMO allocation
        âœ” allocates AMO tokens to an active vault
        âœ” cannot allocate to an inactive vault
        âœ” cannot allocate more than unallocated supply
      AMO deallocation
        âœ” deallocates AMO tokens from an active vault
        âœ” cannot deallocate more than allocated to vault
      AMO vault management
        âœ” enables an AMO vault
        âœ” disables an AMO vault
        âœ” cannot enable an already enabled vault
        âœ” cannot disable an already disabled vault
      AMO supply management
        âœ” decreases AMO supply by burning dStable
        âœ” cannot decrease AMO supply more than available
      Collateral Management
        âœ” transfers collateral from AMO vault to holding vault
        âœ” transfers collateral from holding vault to AMO vault
        âœ” cannot transfer dStable as collateral
        âœ” does not reactivate a disabled vault when transferring collateral
        âœ” emits AllocationSurplus when collateral value exceeds allocation
      Profit Management
        âœ” calculates available vault profits correctly
        âœ” withdraws profits from AMO vault
        âœ” cannot withdraw more than available profits
      Base value conversion
        âœ” converts base value to dStable amount correctly
        âœ” converts dStable amount to base value correctly
      Admin functions
        âœ” allows admin to set collateral vault
        âœ” prevents non-admin from setting collateral vault
      AmoVault manager allowance
        âœ” revokes the old manager allowance and grants it to the new one
        âœ” allows admin to set a custom allowance for the current manager

  CollateralHolderVault for dUSD
    Collateral management
      âœ” allows frxUSD as collateral
      âœ” allows depositing frxUSD
      âœ” disallows depositing non-allowed frxUSD
      âœ” allows USDC as collateral
      âœ” allows depositing USDC
      âœ” disallows depositing non-allowed USDC
      âœ” allows USDT as collateral
      âœ” allows depositing USDT
      âœ” disallows depositing non-allowed USDT
      âœ” allows AUSD as collateral
      âœ” allows depositing AUSD
      âœ” disallows depositing non-allowed AUSD
    Base value calculations
      âœ” calculates total value correctly
      âœ” correctly converts between base value and asset amount
    Administrative functions
      âœ” allows authorized withdrawals
      âœ” prevents unauthorized withdrawals
    exchangeCollateral
      âœ” reverts when fromCollateral is not supported
      âœ” allows swapping unsupported vault collateral for supported collateral in

  CollateralHolderVault for dETH
    Collateral management
      âœ” allows WETH as collateral
      âœ” allows depositing WETH
      âœ” disallows depositing non-allowed WETH
    Base value calculations
      âœ” calculates total value correctly
      âœ” correctly converts between base value and asset amount
    Administrative functions
      âœ” allows authorized withdrawals
      âœ” prevents unauthorized withdrawals

  IssuerV2 for dUSD
    Permissionless issuance
      âœ” issues dUSD in exchange for frxUSD collateral
      âœ” cannot issue dUSD when asset minting is paused for frxUSD
      âœ” issues dUSD in exchange for USDC collateral
      âœ” cannot issue dUSD when asset minting is paused for USDC
      âœ” issues dUSD in exchange for USDT collateral
      âœ” cannot issue dUSD when asset minting is paused for USDT
      âœ” issues dUSD in exchange for AUSD collateral
      âœ” cannot issue dUSD when asset minting is paused for AUSD
      âœ” circulatingDstable calculates correctly for dUSD
      âœ” baseValueToDstableAmount converts correctly for dUSD
      âœ” reverts when issuing with unsupported collateral
    Permissioned and control behaviors
      âœ” only PAUSER_ROLE can set asset minting pause
      âœ” pause prevents minting functions and unpause restores
      âœ” increaseAmoSupply mints dUSD to AMO Manager
      âœ” issueUsingExcessCollateral respects collateral limits for dUSD

  IssuerV2 for dETH
    Permissionless issuance
      âœ” issues dETH in exchange for WETH collateral
      âœ” cannot issue dETH when asset minting is paused for WETH
      âœ” circulatingDstable calculates correctly for dETH
      âœ” baseValueToDstableAmount converts correctly for dETH
      âœ” reverts when issuing with unsupported collateral
    Permissioned and control behaviors
      âœ” only PAUSER_ROLE can set asset minting pause
      âœ” pause prevents minting functions and unpause restores
      âœ” increaseAmoSupply mints dETH to AMO Manager
      âœ” issueUsingExcessCollateral respects collateral limits for dETH

  RedeemerV2 for dUSD
    âœ” per-asset pause prevents redemption
    âœ” global pause prevents redemption and unpause restores
    âœ” only PAUSER_ROLE can set asset pause/unpause
    âœ” isAssetRedemptionEnabled reflects pause state
    âœ” redemption computes amounts correctly within slippage bounds
    Deployment and Configuration
      âœ” has zero default fee and feeReceiver set to deployer by default
    Public Redemption with Fees
      âœ” applies default fee on public redemption and emits Redemption
    Protocol Redemption (No Fees)
      âœ” allows manager to redeem without fees
      âœ” reverts if non-manager calls redeemAsProtocol
    Administrative functions
      âœ” allows admin to set fee receiver
      âœ” reverts when non-admin tries to set fee receiver
      âœ” allows admin to set default redemption fee and enforces max
      âœ” allows admin to set collateral-specific fee and enforces max
      âœ” supports clearing per-asset override (0 bps override -> clear -> fallback to default)

  RedeemerV2 for dETH
    âœ” per-asset pause prevents redemption
    âœ” global pause prevents redemption and unpause restores
    âœ” only PAUSER_ROLE can set asset pause/unpause
    âœ” isAssetRedemptionEnabled reflects pause state
    âœ” redemption computes amounts correctly within slippage bounds
    Deployment and Configuration
      âœ” has zero default fee and feeReceiver set to deployer by default
    Public Redemption with Fees
      âœ” applies default fee on public redemption and emits Redemption
    Protocol Redemption (No Fees)
      âœ” allows manager to redeem without fees
      âœ” reverts if non-manager calls redeemAsProtocol
    Administrative functions
      âœ” allows admin to set fee receiver
      âœ” reverts when non-admin tries to set fee receiver
      âœ” allows admin to set default redemption fee and enforces max
      âœ” allows admin to set collateral-specific fee and enforces max
      âœ” supports clearing per-asset override (0 bps override -> clear -> fallback to default)

  ERC20StablecoinUpgradeable
    Initialization
      âœ” should initialize with correct name and symbol
      âœ” should have 18 decimals
      âœ” should set deployer as default admin
      âœ” should set deployer as pauser
    Role-based functionality
      âœ” should allow minting only by minter role
      âœ” should allow pausing only by pauser role
      âœ” should prevent transfers when paused
    Name and Symbol Update Functionality
      âœ” should allow default admin to update name and symbol
      âœ” should prevent non-admin from updating name and symbol

  dUSD Ecosystem Lifecycle
    Oracle Setup
  âœ“ Successfully read price for dUSD: 1000000000000000000
  âœ“ Successfully read price for USDC: 1000000000000000000
  âœ“ Successfully read price for USDT: 1000000000000000000
  âœ“ Successfully read price for AUSD: 1000000000000000000
  âœ“ Successfully read price for frxUSD: 1000000000000000000
  âœ“ Successfully read price for sfrxUSD: 1100000000000000000
  âœ“ Successfully read price for yUSD: 1100000000000000000
      âœ” verifies oracle prices for all collateral tokens
    System Invariants
      âœ” maintains invariants throughout basic operations
    Full Lifecycle
      âœ” executes a complete lifecycle with multiple users and assets (52ms)

  dETH Ecosystem Lifecycle
    Oracle Setup
  âœ“ Successfully read price for dETH: 1000000000000000000
  âœ“ Successfully read price for WETH: 1000000000000000000
  âœ“ Successfully read price for stETH: 1100000000000000000
      âœ” verifies oracle prices for all collateral tokens
    System Invariants
      âœ” maintains invariants throughout basic operations
    Full Lifecycle
      âœ” executes a complete lifecycle with multiple users and assets (151ms)

  DStakeCollateralVault for sdUSD
    Initialization & Deployment State (from fixture)
      - Should have deployed the vault correctly
      - Should have set immutable state correctly (DStakeToken, dStable)
      - Should grant DEFAULT_ADMIN_ROLE to initialAdmin
      - Router should be set as per beforeEach setup
    Router Management (setRouter)
      - Should only allow admin to set router
      - Should revert if setting router to zero address
      - Should set and replace the router correctly, managing ROUTER_ROLE
    Asset Transfer (sendAsset)
      - Should only allow router (via routerSigner) to send assets
      - Should transfer asset correctly
      - Should revert on insufficient balance
      - Should revert if asset is not supported
    Value Calculation (totalValueInDStable)
      - Should return 0 if no assets are supported
      - Should return 0 if supported asset has zero balance
      - Should return correct value for a single asset with balance
      - Should sum values correctly for multiple supported assets (if possible to set up)
      - Should return 0 after asset balance is removed and adapter is removed
    Supported Asset Removal without Zero Balance
      - Should allow removeSupportedAsset even when balance > 0
      - Should revert sendAsset after asset is removed but balance remains
    Recovery Functions
      rescueToken
        - Should successfully rescue non-restricted tokens
        - Should rescue partial balance
        - Should revert when trying to rescue supported vault assets
        - Should revert when trying to rescue dStable token
        - Should only allow DEFAULT_ADMIN_ROLE to call rescueToken
        - Should revert with zero address receiver
        - Should handle rescue when token balance is insufficient
      rescueETH
        - Should successfully rescue ETH
        - Should only allow DEFAULT_ADMIN_ROLE to call rescueETH
        - Should revert with zero address receiver
        - Should revert when contract has insufficient ETH
        - Should handle rescue when contract has no ETH
      getRestrictedRescueTokens
        - Should return dStable token when no assets are supported
        - Should return all supported assets plus dStable
        - Should update when assets are added/removed
      Integration tests
        - Should rescue multiple different tokens
        - Should prevent rescue of newly added supported assets

  DStakeCollateralVault for sdETH
    Initialization & Deployment State (from fixture)
      - Should have deployed the vault correctly
      - Should have set immutable state correctly (DStakeToken, dStable)
      - Should grant DEFAULT_ADMIN_ROLE to initialAdmin
      - Router should be set as per beforeEach setup
    Router Management (setRouter)
      - Should only allow admin to set router
      - Should revert if setting router to zero address
      - Should set and replace the router correctly, managing ROUTER_ROLE
    Asset Transfer (sendAsset)
      - Should only allow router (via routerSigner) to send assets
      - Should transfer asset correctly
      - Should revert on insufficient balance
      - Should revert if asset is not supported
    Value Calculation (totalValueInDStable)
      - Should return 0 if no assets are supported
      - Should return 0 if supported asset has zero balance
      - Should return correct value for a single asset with balance
      - Should sum values correctly for multiple supported assets (if possible to set up)
      - Should return 0 after asset balance is removed and adapter is removed
    Supported Asset Removal without Zero Balance
      - Should allow removeSupportedAsset even when balance > 0
      - Should revert sendAsset after asset is removed but balance remains
    Recovery Functions
      rescueToken
        - Should successfully rescue non-restricted tokens
        - Should rescue partial balance
        - Should revert when trying to rescue supported vault assets
        - Should revert when trying to rescue dStable token
        - Should only allow DEFAULT_ADMIN_ROLE to call rescueToken
        - Should revert with zero address receiver
        - Should handle rescue when token balance is insufficient
      rescueETH
        - Should successfully rescue ETH
        - Should only allow DEFAULT_ADMIN_ROLE to call rescueETH
        - Should revert with zero address receiver
        - Should revert when contract has insufficient ETH
        - Should handle rescue when contract has no ETH
      getRestrictedRescueTokens
        - Should return dStable token when no assets are supported
        - Should return all supported assets plus dStable
        - Should update when assets are added/removed
      Integration tests
        - Should rescue multiple different tokens
        - Should prevent rescue of newly added supported assets

  DStakeRewardManagerMetaMorpho
    Deployment
      âœ” should deploy with correct parameters
      âœ” should handle deployment with zero URD address
      âœ” should revert with zero addresses
    Admin Functions
      âœ” should allow admin to update URD
      âœ” should allow admin to disable URD
      âœ” should only allow admin to update URD
      âœ” should validate URD interface when setting
      âœ” should allow admin to set as skim recipient
    Reward Skimming
      âœ” should skim single reward token
      âœ” should skim multiple reward tokens
      âœ” should handle skimming with no rewards
      âœ” should only allow manager to skim rewards
    URD Reward Claiming
      âœ” should claim rewards from URD
      âœ” should claim multiple rewards from URD
      âœ” should revert if URD not configured
      âœ” should only allow manager to claim from URD
      âœ” should handle claim failure gracefully
      âœ” should verify rewards are received by the reward manager contract
    Reward Compounding
      âœ” should compound rewards with claimed tokens
      âœ” should handle multiple reward tokens
      âœ” should revert if compound amount below threshold
      âœ” should cap claimed amounts to available balance
    Exchange Asset Processing
      âœ” should process exchange asset through adapter
      âœ” should handle adapter errors gracefully
      âœ” should clear approvals after processing
    Emergency Functions
      âœ” should allow admin to withdraw stuck tokens
      âœ” should only allow admin to emergency withdraw
    View Functions
      âœ” should return URD configuration status
      âœ” should return current skim recipient
      âœ” should return claimed amounts from URD
      âœ” should return zero claimed amount if URD not set
    Integration with RewardClaimable
      âœ” should properly inherit treasury management
      âœ” should properly inherit fee management
      âœ” should properly inherit threshold management
    Edge Cases
      âœ” should handle zero reward amounts
      - should handle adapter returning different asset

  DStakeRouterV2 Integration Tests
    Deployment and Configuration
duplicate definition - ArrayLengthMismatch()
duplicate definition - ArrayLengthMismatch()
âœ… Granted all necessary roles to router contract
âœ… Granted additional roles for testing
âœ… Set router and granted ROUTER_ROLE on collateralVault
âœ… Set vault configurations and added supported assets to collateralVault
âœ… Supported assets in collateralVault: Result(3) [
  '0x1D8D70AD07C8E7E442AD78E4AC0A16f958Eba7F0',
  '0xA9e6Bfa2BF53dE88FEb19761D9b2eE2e821bF1Bf',
  '0x1E3b98102e19D3a164d239BdD190913C2F02E756'
]
âœ… Final supported assets in collateralVault: Result(3) [
  '0x1D8D70AD07C8E7E442AD78E4AC0A16f958Eba7F0',
  '0xA9e6Bfa2BF53dE88FEb19761D9b2eE2e821bF1Bf',
  '0x1E3b98102e19D3a164d239BdD190913C2F02E756'
]
âœ… Set router on dStakeToken
      âœ” Should deploy with correct vault configurations
      âœ” Should have correct active vaults
      âœ” Should validate total allocations equal 100%
      âœ” Should accept configurations that total exactly 1,000,000 basis points (100%)
      âœ” Should reject configurations using old 10,000 basis point scale
    Complete Deposit/Withdrawal Flow
      âœ” Should handle deposits with deterministic vault selection
      âœ” Should handle withdrawals from single vault with deterministic selection
      âœ” Should select exactly 1 vault per deposit with maxVaultsPerOperation=1
    Deterministic Convergence to Target Allocations
After 10 operations: [7459.0%, 1639.3%, 901.6%]
After 20 operations: [5714.3%, 2571.4%, 1714.3%]
After 30 operations: [4876.6%, 2901.2%, 2222.2%]
After 40 operations: [4944.4%, 3000.0%, 2055.6%]
After 50 operations: [5049.5%, 3019.8%, 1930.7%]
Final allocations: 5049.5%, 3019.8%, 1930.7%
Target allocations: [50.0%, 30.0%, 20.0%]
      âœ” Should converge to target allocations over 50+ operations with deterministic selection (158ms)
Initial (skewed): 10000.0%, 0.0%, 0.0%
After 5 deposits: 5000.0%, 3000.0%, 2000.0%
After 10 deposits: 4666.7%, 3333.3%, 2000.0%
After 15 deposits: 5000.0%, 3000.0%, 2000.0%
After 20 deposits: 4800.0%, 3200.0%, 2000.0%
      âœ” Should demonstrate natural velocity adjustment toward targets (62ms)
    Collateral Exchange Functionality
      1) Should exchange collateral between vaults
      âœ” Should revert when exchanging to inactive vault
      âœ” Should revert when called by unauthorized user
    Admin Functions
      âœ” Should allow admin to add new vault configuration
      âœ” Should allow admin to update vault configuration
      âœ” Should allow admin to remove vault configuration
      âœ” Should revert when calling removeVaultConfig on non-existent vault
      âœ” Should allow admin to emergency pause vault
    MaxVaultsPerOperation Constraints
      âœ” Should allow setting maxVaultsPerOperation up to the active vault count
      âœ” Should enforce the cap when the active vault set grows (122ms)
      âœ” Should reject maxVaultsPerOperation of 0
      âœ” Should enforce maxVaultsPerOperation in weighted selection
    Edge Cases
      âœ” Should handle all vaults paused scenario
      âœ” Should handle single vault active scenario
      âœ” Should handle new vault with 0 balance
      âœ” Should handle extreme skew (one vault at 95%)
      âœ” Should handle large withdrawals across multiple vaults
    Gas Cost Consistency
Small deposit gas: 458390
Large deposit gas: 439388
      âœ” Should maintain consistent gas costs regardless of deposit size
Small withdrawal gas: 312006
Large withdrawal gas: 312016
      âœ” Should maintain reasonable gas costs for withdrawals
    Deterministic Selection Verification
Vault selection frequency over 30 deposits (deterministic):
Vault1 (overweight, target 50%): 5 selections
Vault2 (underweight, target 30%): 15 selections
Vault3 (underweight, target 20%): 10 selections
      âœ” Should verify that deterministic selection consistently moves allocations toward targets (219ms)
Balanced state allocations: 4666.7%, 3333.3%, 2000.0%
Deterministic selection distribution when near targets:
Vault1: 12 selections
Vault2: 4 selections
Vault3: 4 selections
      âœ” Should demonstrate deterministic behavior when all vaults are at target (185ms)
    System Integration
      âœ” Should maintain total value integrity across operations
      âœ” Should emit proper allocation snapshots
    Deterministic Gas Efficiency Tests
Deterministic implementation gas usage: 458400
      âœ” Should achieve efficient gas usage with deterministic selection
Gas usage across scenarios: [
  '458390', '439379',
  '446438', '329861',
  '387870', '387870',
  '387466'
]
      âœ” Should maintain consistent gas usage across different vault selection scenarios
    Deterministic Edge Case Validation
      âœ” Should handle single active vault scenario deterministically
Convergence progression:
  Iteration 5: [8000.0%, 1600.0%, 400.0%]
  Iteration 10: [6666.7%, 2000.0%, 1333.3%]
  Iteration 15: [5714.3%, 2571.4%, 1714.3%]
  Iteration 20: [5000.0%, 3000.0%, 2000.0%]
      âœ” Should demonstrate predictable convergence over time (51ms)
Deterministic vault selections over 5 identical deposits: [
  [ '0xa9e6bfa2bf53de88feb19761d9b2ee2e821bf1bf' ],
  [ '0xa9e6bfa2bf53de88feb19761d9b2ee2e821bf1bf' ],
  [ '0x1e3b98102e19d3a164d239bdd190913c2f02e756' ],
  [ '0xa9e6bfa2bf53de88feb19761d9b2ee2e821bf1bf' ],
  [ '0x1e3b98102e19d3a164d239bdd190913c2f02e756' ]
]
      âœ” Should demonstrate reproducible vault selection with same inputs (38ms)

  DStakeRouterV2 Fixes Tests
    Test 1: Withdrawal Shortfall and Remainder Handling
duplicate definition - ArrayLengthMismatch()
duplicate definition - ArrayLengthMismatch()
Vault 0 (0x1D8D70AD07C8E7E442AD78E4AC0A16f958Eba7F0) has 10000.0 shares
Vault 1 (0xA9e6Bfa2BF53dE88FEb19761D9b2eE2e821bF1Bf) has 5999.995402083545896013 shares
Vault 2 (0x1E3b98102e19D3a164d239BdD190913C2F02E756) has 3999.997146121138707406 shares
      âœ” Should handle liquidity shortfall with single-vault deterministic selection
      2) Should properly distribute remainder in withdrawals
      âœ” Should revert when total system liquidity is insufficient
      âœ” Should handle edge case of partial vault liquidity
    Test 2: Proportional Deposits by Underallocation
      3) Should split deposits proportionally to underallocations
      âœ” Should distribute remainder correctly in proportional splits
      4) Should fallback to even split when all vaults are balanced
      âœ” Should handle zero underallocations correctly
    Test 3: ExchangeCollateral Math
      5) Should use previewWithdraw for calculating exchange shares
      âœ” Should handle exchange with vault fees correctly
      âœ” Should handle slippage within reasonable bounds
      âœ” Should revert exchange from inactive vault
      âœ” Should revert exchange to inactive vault
    Test 4: Allocation Total Validation
      âœ” Should return true when total allocations equal 1,000,000 bps
      âœ” Should return false when total allocations don't equal 1,000,000 bps
      âœ” Should handle edge case of zero allocations
      âœ” Should validate after vault removal
      âœ” Should work with maximum basis points
      âœ” Should detect over-allocation beyond 100%
      âœ” Should detect under-allocation below 100%
      âœ” Should handle precision edge cases
    Test 5: Optimized getVaultBalance
      âœ” Should return same values for both getVaultBalance methods
      âœ” Should handle vaults with zero balances
      âœ” Should avoid self-calls in optimized version
      âœ” Should handle adapter lookup failures gracefully
      âœ” Should handle adapter conversion failures gracefully
      âœ” Should handle ERC20 balanceOf failures gracefully
    Security Fixes Tests
      Test 1: Allowance Clearing
        âœ” Should clear allowances after deposit operations
        âœ” Should clear allowances after withdrawal operations
        âœ” Should not leave residual allowances in adapter contracts
      Test 2: ExchangeCollateral Slippage Protection
        6) Should succeed with proper minToVaultAssetAmount
        âœ” Should revert when actual output is less than minToVaultAssetAmount
        âœ” Should work with minToVaultAssetAmount = 0 (no protection)
        âœ” Should handle edge case with very small slippage tolerance
      Test 3: ExchangeCollateral Reentrancy Protection
        âœ” Should verify nonReentrant modifier is present
        âœ” Should handle multiple concurrent exchanges correctly
        âœ” Should prevent reentrancy during exchange operations
      Test 4: MetaMorphoConversionAdapter Admin Role
        âœ” Should deploy adapter with custom initialAdmin
        âœ” Should verify both initialAdmin and collateralVault have DEFAULT_ADMIN_ROLE
        âœ” Should allow initialAdmin to call setMaxSlippage
        âœ” Should revert deployment with zero address initialAdmin
        âœ” Should allow collateralVault admin role to call setMaxSlippage
        âœ” Should properly handle admin role transfers
    Integration Test: Combined Fixes
      âœ” Should demonstrate all fixes working together (49ms)

  DStake Solver Mode Tests
    Solver Mode: solverDepositAssets
duplicate definition - ArrayLengthMismatch()
duplicate definition - ArrayLengthMismatch()
âœ… Granted all necessary roles to router contract
âœ… Granted additional roles for testing
âœ… Set router and granted ROUTER_ROLE on collateralVault
âœ… Set vault configurations and added supported assets to collateralVault
âœ… Supported assets in collateralVault: Result(3) [
  '0x1D8D70AD07C8E7E442AD78E4AC0A16f958Eba7F0',
  '0xA9e6Bfa2BF53dE88FEb19761D9b2eE2e821bF1Bf',
  '0x1E3b98102e19D3a164d239BdD190913C2F02E756'
]
âœ… Final supported assets in collateralVault: Result(3) [
  '0x1D8D70AD07C8E7E442AD78E4AC0A16f958Eba7F0',
  '0xA9e6Bfa2BF53dE88FEb19761D9b2eE2e821bF1Bf',
  '0x1E3b98102e19D3a164d239BdD190913C2F02E756'
]
âœ… Set router on dStakeToken
      âœ” Should deposit assets into multiple vaults via DStakeToken
      âœ” Should revert with slippage protection when minShares not met
      âœ” Should revert when vaults and assets arrays have mismatched lengths
      âœ” Should revert when empty arrays provided
      âœ” Should revert when total assets is zero
    Solver Mode: solverDepositShares
      âœ” Should deposit shares into multiple vaults via DStakeToken
      âœ” Should handle zero shares correctly
    Solver Mode: solverWithdrawAssets
      âœ” Should withdraw assets from multiple vaults via DStakeToken
      âœ” Should revert when maxShares exceeded
      âœ” Should handle partial withdrawals correctly
    Solver Mode: solverWithdrawShares
      âœ” Should withdraw shares from multiple vaults via DStakeToken
      âœ” Should handle zero vault shares correctly
    Solver Mode: Atomic Failure Behavior
      âœ” Should revert entire solverDepositAssets transaction if one vault fails
      âœ” Should revert entire solverWithdrawAssets transaction if one vault fails
    Solver Mode: Direct Router Calls
      âœ” Should allow direct solverDepositAssets call with proper role
      âœ” Should revert direct router call without proper role
      âœ” Should allow direct solverWithdrawAssets call with proper role
    Solver Mode: Event Emissions
      âœ” Should emit proper events for solverDepositAssets
      âœ” Should emit proper events for solverWithdrawShares with fees
    Solver Mode: Share Accounting Correctness
      âœ” Should maintain correct share accounting across multiple solver deposits
      âœ” Should maintain correct accounting during solver withdrawals
    Solver Mode: Complex Multi-User Scenarios
      âœ” Should handle concurrent solver operations correctly

  DStakeToken for sdUSD
    Initialization & State
      - Should set immutable dStable address via asset()
      - Should revert initialize if dStable address is zero
      - Should grant DEFAULT_ADMIN_ROLE to initialAdmin
      - Should have collateralVault and router set from fixture
      - Should set maxWithdrawalFeeBps constant
      - New instance withdrawalFeeBps should be zero by default
      - Fixture withdrawalFeeBps should equal initial config value
      - Should have correct name and symbol
      - Should use same decimals as underlying dStable
    Role-Based Access Control & Configuration
      setCollateralVault
        - Should allow admin to set collateralVault
        - Should revert if non-admin calls setCollateralVault
        - Should revert if setting collateralVault to zero
      setRouter
        - Should allow admin to set router
        - Should revert if non-admin calls setRouter
        - Should revert if setting router to zero
      Role Management
        - Should allow admin to grant and revoke FEE_MANAGER_ROLE
      setWithdrawalFee
        - Should allow fee manager to set withdrawal fee
        - Should revert if non-fee-manager sets withdrawal fee
        - Should revert if fee exceeds maxWithdrawalFeeBps
        - Should allow setting fee to 0
    ERC4626 Core Functionality (Deposits & Minting)
      - totalAssets returns 0 if collateralVault not set
      - totalAssets returns 0 if collateralVault has no assets
      - totalAssets delegates correctly to collateralVault
      - previewDeposit returns expected shares
      - maxDeposit returns uint256 max
      convertToShares & convertToAssets
        - should handle zero correctly
        - should convert assets to shares 1:1 when empty
        - should reflect share price change when vault has extra assets
      deposit function
        - should revert if router not set
        - should revert with ERC20InvalidReceiver when receiver is zero
        - should revert on insufficient balance
        - should mint shares and emit Deposit event
      mint function
        - should mint shares and emit Deposit event via mint
    ERC4626 Core Functionality (Withdrawals & Redeeming)
      - previewWithdraw returns expected shares
      - previewRedeem returns expected assets
      - maxWithdraw returns deposit amount
      - maxRedeem returns share balance
      - should withdraw assets and burn shares
      - should redeem shares and transfer assets
    ERC4626 Withdrawals & Redeeming with Fees
      - should withdraw assets with fee deducted
      - should redeem shares with fee deducted
      - previewWithdraw returns expected shares including fee
      - previewRedeem returns expected assets after fee
      - maxWithdraw returns net amount after fee and allows full withdrawal
    Security: Unauthorized withdrawal protection
      - should prevent unauthorized withdrawal without allowance
      - should prevent unauthorized redeem without allowance
      - should allow withdrawal with proper allowance

  DStakeToken for sdETH
    Initialization & State
      - Should set immutable dStable address via asset()
      - Should revert initialize if dStable address is zero
      - Should grant DEFAULT_ADMIN_ROLE to initialAdmin
      - Should have collateralVault and router set from fixture
      - Should set maxWithdrawalFeeBps constant
      - New instance withdrawalFeeBps should be zero by default
      - Fixture withdrawalFeeBps should equal initial config value
      - Should have correct name and symbol
      - Should use same decimals as underlying dStable
    Role-Based Access Control & Configuration
      setCollateralVault
        - Should allow admin to set collateralVault
        - Should revert if non-admin calls setCollateralVault
        - Should revert if setting collateralVault to zero
      setRouter
        - Should allow admin to set router
        - Should revert if non-admin calls setRouter
        - Should revert if setting router to zero
      Role Management
        - Should allow admin to grant and revoke FEE_MANAGER_ROLE
      setWithdrawalFee
        - Should allow fee manager to set withdrawal fee
        - Should revert if non-fee-manager sets withdrawal fee
        - Should revert if fee exceeds maxWithdrawalFeeBps
        - Should allow setting fee to 0
    ERC4626 Core Functionality (Deposits & Minting)
      - totalAssets returns 0 if collateralVault not set
      - totalAssets returns 0 if collateralVault has no assets
      - totalAssets delegates correctly to collateralVault
      - previewDeposit returns expected shares
      - maxDeposit returns uint256 max
      convertToShares & convertToAssets
        - should handle zero correctly
        - should convert assets to shares 1:1 when empty
        - should reflect share price change when vault has extra assets
      deposit function
        - should revert if router not set
        - should revert with ERC20InvalidReceiver when receiver is zero
        - should revert on insufficient balance
        - should mint shares and emit Deposit event
      mint function
        - should mint shares and emit Deposit event via mint
    ERC4626 Core Functionality (Withdrawals & Redeeming)
      - previewWithdraw returns expected shares
      - previewRedeem returns expected assets
      - maxWithdraw returns deposit amount
      - maxRedeem returns share balance
      - should withdraw assets and burn shares
      - should redeem shares and transfer assets
    ERC4626 Withdrawals & Redeeming with Fees
      - should withdraw assets with fee deducted
      - should redeem shares with fee deducted
      - previewWithdraw returns expected shares including fee
      - previewRedeem returns expected assets after fee
      - maxWithdraw returns net amount after fee and allows full withdrawal
    Security: Unauthorized withdrawal protection
      - should prevent unauthorized withdrawal without allowance
      - should prevent unauthorized redeem without allowance
      - should allow withdrawal with proper allowance

  Fee Accounting Regression Test
    Fee Accounting in totalAssets()
      7) Should include dStable balance held by DStakeToken contract in totalAssets()
      8) Should properly account for accumulated fees from multiple solver withdrawals
      9) Should maintain accurate share pricing with accumulated fees
    reinvestFees() Function
      10) "before each" hook for "Should reinvest accumulated fees back into the vault"
    Value Conservation Under Multiple Operations
      11) Should maintain total value across multiple solver withdrawals and reinvestments
      12) Should handle edge case with zero fees correctly
      13) Should handle large withdrawal with significant fees
    Integration with Share Pricing
      14) Should ensure no value leakage from accounting set
